using System.Threading;
using System.Threading.Tasks;
using moo.common.Scripting;
using NUnit.Framework;

namespace Tests
{
    public class ForthTokenizerTests
    {
        [Test]
        public async Task KeepVars()
        {
            const string programText = ": parse_args[ dict:opts str:args int:ignore -- arr:opts 0 | 1 ]\n    1 var! firstopt\n    begin\n        args @ striplead \" \" split args !\n        dup while\n        \n        dup \"{#|#by}\" smatch if pop show_usage 1 exit then\n        \n        firstopt @ if\n            0 firstopt !\n            ignore @ if\n                dup \"#help\"     swap stringpfx if pop continue then\n                dup \"#default\"  swap 3 stringminpfx if pop continue then\n                dup \"#reset\"    swap stringpfx if pop continue then\n$iflib $adultlock\n                dup \"#adult\"    swap stringpfx if pop continue then\n                dup \"#prude\"    swap stringpfx if pop continue then\n$endif\n                dup \"#never\"    swap stringpfx over strlen 2 > and if pop continue then\n                dup \"#always\"   swap stringpfx if pop continue then\n                dup \"#whereis\"  swap stringpfx if pop continue then\n                dup \"#set\"      swap stringpfx if pop continue then\n                dup \"#setdir\"   swap stringpfx if pop continue then\n            else\n                dup \"#help\"     swap stringpfx if pop show_usage_long 1 exit then\n                dup \"#default\"  swap 3 stringminpfx if pop args @ set_default 1 exit then\n                dup \"#reset\"    swap stringpfx if pop \"\" set_default 1 exit then\n$iflib $adultlock\n                compare-my-age if\n                    dup \"#adult\"    swap stringpfx if pop 1 set_adult 1 exit then\n                    dup \"#prude\"    swap stringpfx if pop 0 set_adult 1 exit then\n                then\n$endif\n                dup \"#never\"    swap stringpfx over strlen 2 > and if pop set_never 1 exit then\n                dup \"#always\"   swap stringpfx if pop set_always 1 exit then\n                dup \"#whereis\"  swap stringpfx if pop set_whereis 1 exit then\n                dup \"#set\"      swap stringpfx if pop args @ set_wa_prop 1 exit then\n                dup \"#setdir\"   swap stringpfx if pop args @ set_wadir_prop 1 exit then\n            then\n        then\n        \n        dup \"#names\"      swap stringpfx if pop \"names\"   opts @ \"optcol\" ->[] opts ! continue then\n        dup \"#comments\"   swap stringpfx if pop \"#notes\" then\n        dup \"#notes\"      swap stringpfx if pop \"notes\"   opts @ \"optcol\" ->[] opts ! continue then\n        dup \"#wfnames\"    swap stringpfx if pop \"wfnames\" opts @ \"optcol\" ->[] opts ! continue then\n        dup \"#directions\" swap stringpfx if pop \"dir\"     opts @ \"optcol\" ->[] opts ! continue then\n        \n        dup \"#bycount\"    swap stringpfx if pop \"cnt\" opts @ \"sortcol\" ->[] opts ! continue then\n        dup \"#byactive\"   swap stringpfx if pop \"act\" opts @ \"sortcol\" ->[] opts ! continue then\n        dup \"#bywfl\"      swap stringpfx if pop \"#bywatchfor\" then\n        dup \"#bywatchfor\" swap stringpfx if pop \"wfl\" opts @ \"sortcol\" ->[] opts ! 1 opts @ \"mincnt\" ->[] opts ! continue then\n        dup \"#byroom\"     swap stringpfx if pop \"locname\" opts @ \"sortcol\" ->[] 1 swap \"ascend\" ->[] opts ! continue then\n \n        dup \"#old\"        swap stringpfx if pop \"old\" opts @ \"style\" ->[] \"2ln\" swap \"format\" ->[] opts ! continue then\n        dup \"#new\"        swap stringpfx if pop \"new\" opts @ \"style\" ->[] \"col\" swap \"format\" ->[] opts ! continue then\n \n        dup \"#columnar\"   swap stringpfx if pop \"col\" opts @ \"format\" ->[] opts ! continue then\n        dup \"#twoline\"    swap stringpfx if pop \"2ln\" opts @ \"format\" ->[] opts ! continue then\n        dup \"#oneline\"    swap stringpfx if pop \"1ln\" opts @ \"format\" ->[] opts ! continue then\n \n        dup \"#quell\"      swap stringpfx if pop \"yes\" opts @ \"quell\"  ->[] opts ! continue then\n        dup \"#all\"        swap stringpfx if pop 1 opts @ \"showall\"  ->[] opts ! continue then\n        dup \"#reversed\"   swap stringpfx if pop opts @ \"ascend\" [] not opts @ \"ascend\" ->[] opts ! continue then\n \n        dup number? if atoi opts @ \"mincnt\" ->[] opts ! continue then\n        ignore @ not if\n            pop show_usage 1 exit\n        then\n    repeat pop\n    opts @ 0\n;";

            var preproc = await ForthPreprocessor.Preprocess(null, null, programText, CancellationToken.None);
            Assert.NotNull(preproc.ProcessedProgram);

            var result = await ForthTokenizer.Tokenzie(null, preproc.ProcessedProgram!, new System.Collections.Generic.Dictionary<string, ForthVariable>());
            Assert.NotNull(result);
        }
    }
}